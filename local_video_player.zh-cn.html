<!DOCTYPE html>
<html>

<head>
    <title>本地视频播放器</title>
    <script src="./download.js"></script>
    <script src="./local_page.zh-cn.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.2.1"></script>
    <link rel="StyleSheet" href="./local_page.css" type="text/css" />

    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div class="video-container">
        <div id="videoTitle" class="video-title"></div>
        <video controls id="hlsVideo">
        </video>
    </div>
    <script>
        const language = 'zh-cn'
        window.VideoTogetherEasyShare = 'disabled'
        const m3u8Key = window.location.hash.substring(1)
        const m3u8Url = (window.location.hash.substring(1)).split('-end-')[1];

        setTimeout(() => {
            playM3u8(m3u8Url)
        }, 1000);
        async function playM3u8(url) {

            let m3u8Data = await readFromIndexedDB('m3u8s', m3u8Key);
            document.querySelector("#videoTitle").innerText = m3u8Data.title;
            console.log(m3u8Data.data)
            let swM3u8Content = transferToSwM3u8(m3u8Data.data, url, m3u8Data.m3u8Id)
            console.log(swM3u8Content);
            navigator.serviceWorker.controller.postMessage({
                source: "VideoTogether",
                type: 2013,
                data: swM3u8Content
            });

            let hlsVideo = document.querySelector("#hlsVideo");
            try {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        // debug: true,
                        autoStartLoad: true,
                        fragLoadingMaxRetry: 1000,
                        manifestLoadingMaxRetry: 1000,
                        levelLoadingMaxRetry: 1000
                    });
                    let m3u8Url = (url);
                    hls.loadSource('/fetch-current-m3u8-content');
                    hls.attachMedia(hlsVideo);
                    hlsVideo.load();
                } else {
                    hlsVideo.src = `/fetch-current-m3u8-content`
                    hlsVideo.load()
                }
            } catch { }
        }
    </script>
</body>

</html>