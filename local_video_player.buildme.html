<!DOCTYPE html>
<html>

<head>
    <title>{$LocalVideoPlayerTitle$}</title>
    <script src="./download.js"></script>
    <script src="./local_page.{$language$}.js"></script>
    <script src="./hls.js@1.2.1"></script>
    <link rel="StyleSheet" href="./local_page.css" type="text/css" />
    <script src="./assets/ffmpeg/package/dist/umd/ffmpeg.js"></script>
    <script src="./assets/util/package/dist/umd/index.js"></script>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div class="video-container">
        <div id="videoTitle" class="video-title"></div>
        <video playsinline controls id="hlsVideo">
        </video>
        <button class="button" onclick="transcode()">Download as file(experimental)</button>
        <p id="message"></p>
    </div>
    <script>
        const language = '{$language$}'
        window.VideoTogetherEasyShare = 'disabled'
        const m3u8Key = window.location.hash.substring(1)
        const m3u8Url = (window.location.hash.substring(1)).split('-end-')[1];

        setTimeout(() => {
            playM3u8(m3u8Url)
        }, 1000);
        async function playM3u8(url) {

            let m3u8Data = await readFromIndexedDB('m3u8s', m3u8Key);
            document.querySelector("#videoTitle").innerText = m3u8Data.title;
            console.log(m3u8Data.data)
            let swM3u8Content = transferToSwM3u8(m3u8Data.data, url, m3u8Data.m3u8Id)
            console.log(swM3u8Content);
            navigator.serviceWorker.controller.postMessage({
                source: "VideoTogether",
                type: 2013,
                data: swM3u8Content
            });

            let hlsVideo = document.querySelector("#hlsVideo");
            try {
                if (Hls.isSupported()) {
                    const hls = new Hls({
                        // debug: true,
                        autoStartLoad: true,
                        fragLoadingMaxRetry: 1000,
                        manifestLoadingMaxRetry: 1000,
                        levelLoadingMaxRetry: 1000,
                    });
                    let m3u8Url = (url);
                    hls.loadSource('/fetch-current-m3u8-content');
                    hls.attachMedia(hlsVideo);
                    hlsVideo.load();
                } else {
                    hlsVideo.src = `/fetch-current-m3u8-content`
                    hlsVideo.load()
                }
            } catch { }
        }
    </script>
    <script>
        const { fetchFile } = FFmpegUtil;
        const { FFmpeg } = FFmpegWASM;
        let ffmpeg = null;
        const transcode = async () => {

            ffmpeg = new FFmpeg();
            const message = document.getElementById('message');
            async function onCompleted() {

                const data = await ffmpeg.readFile('output.mp4');

                // ffmpeg.terminate()
                const blob = new Blob([data.buffer], { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${m3u8Data.title}.mp4`;
                a.click();
            }
            ffmpeg.on("log", async ({ message }) => {
                console.log(message);
                if (message == 'Close file: output.mp4 successfully.') {
                    onCompleted();
                }
                if (message.startsWith('Close file: ')) {
                    const filename = message.split('Close file: ')[1].split(' successfully.')[0];
                    if (filename != 'output.mp4') {
                        await ffmpeg.deleteFile(filename)
                    }
                    console.log(filename);
                }
            })
            ffmpeg.on("progress", ({ progress, time }) => {
                message.innerText = `transcoding: ${progress * 100} %`;
            });
            message.innerText = "Downloading FFmpeg, please wait a few minutes"
            await ffmpeg.load({
                coreURL: "/assets/core/package/dist/umd/ffmpeg-core.js",
            });
            let globalId = 0;
            const files = []
            const urlTrans = (url) => {
                console.log(url)
                const filename = (globalId++) + url.split('/').pop();
                files.push({
                    name: filename,
                    url: url
                })
                return './' + filename;
            }

            let m3u8Data = await readFromIndexedDB('m3u8s', m3u8Key);
            let swM3u8Content = transferToSwM3u8(m3u8Data.data, m3u8Url, m3u8Data.m3u8Id, urlTrans)
            await ffmpeg.writeFile('input.m3u8', swM3u8Content)

            try {
                await ffmpeg.exec(['-allowed_extensions', 'ALL', '-i', 'input.m3u8', '-c', 'copy', 'output.mp4']);
            } catch (e) {
                console.error(e);
            }

            setTimeout(async () => {
                for (let i = 0; i < files.length; i++) {
                    // message.innerText = `loading data: ${parseInt((i + 1) / files.length * 100)} %`;
                    let item = files[i];
                    try {
                        await ffmpeg.writeFile(item.name, await fetchFile(item.url));
                    } catch (e) {
                        console.error(e);
                    }
                }
            }, 1);


        }
    </script>
</body>

</html>